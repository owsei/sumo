<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cesium - Demo CZML</title>
  <!-- Cesium from CDN -->
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.109/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #controls {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-family: Arial, sans-serif;
      z-index: 2;
      max-width: 320px;
    }
    #controls button, #controls input, #controls label, #controls select { display:block; width:100%; margin-top:6px }
    #footer { position: absolute; left: 12px; bottom: 12px; background: rgba(255,255,255,0.9); padding:8px; border-radius:6px; font-size:13px }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <div id="controls">
    <strong>Demo CZML - Cesium</strong>
    <label for="czmlFile">Cargar CZML (archivo local):</label>
    <input id="czmlFile" type="file" accept=".czml,.json" />

    <label for="czmlUrl">o cargar desde URL (http(s)):</label>
    <input id="czmlUrl" type="text" placeholder="https://example.com/traffic.czml" />
    <button id="loadUrl">Cargar URL</button>

    <label for="clockRate">Velocidad de simulación (reloj):</label>
    <select id="clockRate">
      <option value="1">1× (tiempo real)</option>
      <option value="2">2×</option>
      <option value="5">5×</option>
      <option value="10">10×</option>
    </select>

    <button id="resetView">Ajustar vista al CZML</button>
    <button id="toggleTerrain">Activar/Desactivar terreno (requiere ionAccessToken)</button>

    <hr />
    <div style="font-size:13px; color:#333">
      <strong>Instrucciones:</strong>
      <ul style="margin:6px 0 0 18px; padding:0">
        <li>Coloca tu <code>traffic.czml</code> en la misma carpeta y cárgalo con "Cargar CZML (archivo local)".</li>
        <li>O pega una URL pública a un CZML y pulsa "Cargar URL".</li>
        <li>Si tus muestras usan altitudes reales, Cesium las respetará — si no, aparecerán a nivel del suelo.</li>
      </ul>
    </div>
  </div>

  <div id="footer">Demo local — guarda este archivo como <code>cesium_czml_example.html</code> y ábrelo en un servidor local (<code>python -m http.server</code>) para evitar restricciones de CORS al cargar archivos locales.</div>

  <script src="https://cdn.jsdelivr.net/npm/cesium@1.109/Build/Cesium/Cesium.js"></script>
  <script>
    // === Inicialización Cesium Viewer ===
    // Si quieres usar Cesium World Terrain, asigna aquí tu token de Cesium Ion:
    const ION_TOKEN = null; // <--- si tienes token ponlo entre comillas: 'pk.xxx'

    if (ION_TOKEN) {
      Cesium.Ion.defaultAccessToken = ION_TOKEN;
    }

    const viewer = new Cesium.Viewer('cesiumContainer', {
      timeline: true,
      animation: true,
      baseLayerPicker: true,
      sceneModePicker: true,
      navigationHelpButton: false
    });

    let terrainEnabled = false;

    // Muestra CZML de ejemplo (si no se carga nada)
    // const sampleCzml = [
    //   { id: 'document', name: 'Sample CZML', version: '1.0' },
    //   {
    //     id: 'vehicle_1',
    //     name: 'Vehículo ejemplo',
    //     availability: '2025-10-15T00:00:00Z/2025-10-15T00:00:30Z',
    //     position: {
    //       epoch: '2025-10-15T00:00:00Z',
    //       cartographicDegrees: [
    //         0, -1.6482, 42.8145, 430,
    //         10, -1.6480, 42.8150, 432,
    //         20, -1.6475, 42.8158, 433
    //       ]
    //     },
    //     point: { pixelSize: 8, color: { rgba: [255, 0, 0, 255] } },
    //     path: { show: true, leadTime: 0, trailTime: 60 }
    //   }
    // ];

    // // Carga CZML por defecto
    // let czmlDataSource = new Cesium.CzmlDataSource();
    // viewer.dataSources.add(czmlDataSource);
    // czmlDataSource.load(sampleCzml).then(() => {
    //   viewer.zoomTo(czmlDataSource);
    // });
    

    function puntoPamplona() {
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(-1.6756, 42.7415, 6500),
        orientation: {
          heading: Cesium.Math.toRadians(10.0),
          pitch: Cesium.Math.toRadians(-40.0),
          roll: 0.0,
        },
      });
    }
    

    // Función para cargar CZML desde texto/objeto
    async function loadCzmlFromText(text) {
      try {
        // intenta parsear JSON (puede ser un array CZML)
        const parsed = JSON.parse(text);
        // reemplaza datasource existente
        viewer.dataSources.remove(czmlDataSource);
        czmlDataSource = new Cesium.CzmlDataSource();
        viewer.dataSources.add(czmlDataSource);
        await czmlDataSource.load(parsed);
        viewer.zoomTo(czmlDataSource);
      } catch (e) {
        alert('Error al parsear CZML: ' + e.message);
        console.error(e);
      }
    }

    // Cargar CZML desde archivo input
    document.getElementById('czmlFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        loadCzmlFromText(evt.target.result);
      };
      reader.readAsText(file);
    });

    // Cargar desde URL
    document.getElementById('loadUrl').addEventListener('click', async function() {
      const url = document.getElementById('czmlUrl').value.trim();
      if (!url) return alert('Introduce una URL válida.');
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);
        const text = await resp.text();
        loadCzmlFromText(text);
      } catch (err) {
        alert('Error cargando URL: ' + err.message);
        console.error(err);
      }
    });

    // Cambiar velocidad del reloj
    document.getElementById('clockRate').addEventListener('change', function(e) {
      const rate = Number(e.target.value);
      viewer.clock.multiplier = rate;
    });

    // Reset view
    document.getElementById('resetView').addEventListener('click', function() {
      viewer.zoomTo(czmlDataSource);
    });

    // Toggle terrain (requires Ion token and will request terrain)
    document.getElementById('toggleTerrain').addEventListener('click', async function() {
      if (!ION_TOKEN) {
        alert('Para usar terreno 3D necesitas establecer ION_TOKEN en el código (tu Cesium Ion access token).');
        return;
      }
      if (!terrainEnabled) {
        const terrain = Cesium.createWorldTerrain();
        await viewer.terrainProvider = terrain;
        terrainEnabled = true;
      } else {
        viewer.terrainProvider = new Cesium.EllipsoidTerrainProvider();
        terrainEnabled = false;
      }
    });

    // Pequeña mejora: cuando se añade una entidad con SampledPositionProperty, sincronizar el reloj
    czmlDataSource.changedEvent.addEventListener(function() {
      const entities = czmlDataSource.entities.values;
      // Encuentra intervalo de disponibilidad más amplio para configurar el reloj
      let start, stop;
      entities.forEach(e => {
        const avail = e.availability;
        if (!avail) return;
        const parts = avail.split('/');
        if (parts.length===2) {
          const s = Cesium.JulianDate.fromIso8601(parts[0]);
          const e2 = Cesium.JulianDate.fromIso8601(parts[1]);
          if (!start || Cesium.JulianDate.lessThan(s, start)) start = s;
          if (!stop || Cesium.JulianDate.greaterThan(e2, stop)) stop = e2;
        }
      });
      if (start && stop) {
        viewer.clock.startTime = start.clone();
        viewer.clock.stopTime = stop.clone();
        viewer.clock.currentTime = start.clone();
        viewer.timeline.updateFromClock();
        viewer.clock.shouldAnimate = true;
      }
    });
    
    let czmlDataSource = new Cesium.CzmlDataSource.load("czml_3Dmodels_sample.czml");
    puntoPamplona();
    
  </script>
</body>
</html>